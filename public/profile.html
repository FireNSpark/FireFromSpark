<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Your Profile • UNHINGED</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <header class="wrap">
    <strong>UNHINGED</strong>
    <button id="logout" class="ghost" type="button">Log out</button>
  </header>

  <main class="wrap">
    <h1>Profile</h1>
    <p id="status" class="muted">Loading…</p>

    <div id="profileBox" style="display:none">
      <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="displayName" placeholder="Display name">
        <button id="save" class="primary" type="button">Save</button>
        <button id="deleteAcct" class="ghost" type="button">Delete account</button>
      </div>

      <div style="margin-top:16px;opacity:.8">
        Email: <span id="email">—</span>
      </div>
    </div>
  </main>

  <!-- IMPORTANT: Firebase first, then profile.js -->
  <script type="module" src="./js/firebase.js"></script>
  <script type="module">
    import { auth } from "./js/firebase.js";
    import { onAuthStateChanged, updateProfile, signOut, deleteUser } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const boxEl = $("profileBox");
    const nameInput = $("displayName");
    const emailOut = $("email");
    const saveBtn = $("save");
    const delBtn = $("deleteAcct");
    const logoutBtn = $("logout");

    function msg(text = "", ok = false) {
      if (!statusEl) return;
      statusEl.textContent = text;
      statusEl.className = ok ? "ok" : "warn";
    }
    function showBox(show) {
      if (boxEl) boxEl.style.display = show ? "block" : "none";
    }

    let first = true;
    onAuthStateChanged(auth, (u) => {
      if (u) {
        showBox(true);
        if (emailOut) emailOut.textContent = u.email || "—";
        if (nameInput) nameInput.value = u.displayName || "";
        msg("", true);
      } else if (!first) {
        msg("You’re signed out.", false);
      }
      first = false;
    });

    saveBtn?.addEventListener("click", async () => {
      const u = auth.currentUser;
      if (!u) { msg("You’re signed out. Log in again.", false); return; }
      const name = (nameInput?.value || "").trim();
      if (!name) { msg("Enter a display name.", false); return; }
      try {
        await updateProfile(u, { displayName: name });
        msg("Saved.", true);
        location.replace("./index.html"); // redirect to main app
      } catch (e) {
        msg(e?.message || "Couldn't save.", false);
      }
    });

    delBtn?.addEventListener("click", async () => {
      const u = auth.currentUser;
      if (!u) return;
      if (!confirm("Delete your account? This cannot be undone.")) return;
      try {
        await deleteUser(u);
        msg("Account deleted.", true);
        location.replace("./login.html");
      } catch (e) {
        msg(e?.message || "Couldn't delete account.", false);
      }
    });

    logoutBtn?.addEventListener("click", async () => {
      try {
        await signOut(auth);
        location.replace("./login.html");
      } catch (e) {
        msg(e?.message || "Couldn't sign out.", false);
      }
    });
  </script>
</body>
</html>
